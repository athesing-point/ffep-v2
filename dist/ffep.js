"use strict";(()=>{var h={PDC:"17448046178191022",PDD:"17448045555816402"};function l(c,e){let t;return function(...i){return new Promise(n=>{let o=async()=>{clearTimeout(t),n(await c.apply(this,i))};clearTimeout(t);let a=typeof e=="function"?e(...i):e;t=setTimeout(o,a)})}}var r=class{constructor(){this.form=null,this.addressInput=null,this.autocompleteContainer=null,this.suggestions=[],this.selectedIndex=-1,this.isAutocompleteVisible=!1,this.apiCallCount=0,this.cacheHits=0,this.cacheMisses=0,this.cacheErrors=0,this.lastQuery="",this.CACHE_PREFIX="ffep_cache_",this.MAX_CACHE_ITEMS=50,this.cleanupCache(),console.log("FFEP Cache Initialized");let e=window.location.hostname;this.smartyKey=e.includes(".dev")?h.PDD:h.PDC,this.debouncedFetchSuggestions=l(this.fetchSuggestions.bind(this),t=>t.length<=4?50:200)}cleanupCache(){try{let e=this.getCacheKeys().length,t=this.getCacheKeys();if(t.length>this.MAX_CACHE_ITEMS){let s=t.slice(0,t.length-this.MAX_CACHE_ITEMS);s.forEach(i=>sessionStorage.removeItem(i)),console.log(`Cache Cleanup: Removed ${s.length} items. Before: ${e}, After: ${this.getCacheKeys().length}`)}}catch(e){console.warn("Cache cleanup failed:",e),this.cacheErrors++}}getCacheKeys(){return Object.keys(sessionStorage).filter(e=>e.startsWith(this.CACHE_PREFIX)).sort((e,t)=>{let s=JSON.parse(sessionStorage.getItem(e))?.timestamp||0,i=JSON.parse(sessionStorage.getItem(t))?.timestamp||0;return s-i})}getCachedItem(e){try{let t=sessionStorage.getItem(this.CACHE_PREFIX+e);if(!t)return console.log(`Cache Miss: ${e}`),this.cacheMisses++,null;let s=JSON.parse(t);return Date.now()-s.timestamp>30*60*1e3?(console.log(`Cache Expired: ${e}`),sessionStorage.removeItem(this.CACHE_PREFIX+e),this.cacheMisses++,null):(console.log(`Cache Hit: ${e}`),this.cacheHits++,s.data)}catch(t){return console.warn("Cache retrieval failed:",t),this.cacheErrors++,null}}setCachedItem(e,t){try{let s={timestamp:Date.now(),data:t};sessionStorage.setItem(this.CACHE_PREFIX+e,JSON.stringify(s)),console.log(`Cache Set: ${e}, Items in cache: ${this.getCacheKeys().length}`),this.cleanupCache()}catch(s){console.warn("Cache storage failed:",s),this.cacheErrors++;try{this.cleanupCache(),sessionStorage.setItem(this.CACHE_PREFIX+e,JSON.stringify(cacheItem)),console.log(`Cache Set Retry Successful: ${e}`)}catch(i){console.warn("Cache storage retry failed:",i),this.cacheErrors++}}}init(){if(this.form=document.querySelector('form[data-ffep="form"]'),!this.form){console.error("data-ffep='form' element not found");return}this.addressInput=this.form.querySelector('[data-ffep="address"]'),this.addressInput&&(this.setupAutocomplete(),this.setupFormHandling())}setupAutocomplete(){this.autocompleteContainer=document.querySelector(".ffep-autocomplete"),this.autocompleteContainer&&(this.addressInput.addEventListener("input",this.handleInput.bind(this)),this.addressInput.addEventListener("keydown",this.handleKeydown.bind(this)),document.addEventListener("click",this.handleClickOutside.bind(this)),this.autocompleteContainer.addEventListener("mouseover",this.handleMouseOver.bind(this)))}setupFormHandling(){this.form.addEventListener("submit",async e=>{e.preventDefault();let t=this.addressInput.value,s=encodeURIComponent(t).replace(/%20/g,"+"),o=`https://home.point.${new URL(window.location.href).hostname.includes(".dev")?"dev":"com"}/?Enter+your+home+address=${s}&address=${s}`;window.location.replace(o)})}async handleInput(e){let t=e.target.value;if(t.length<3){this.hideSuggestions();return}try{let s=await this.debouncedFetchSuggestions(t);s&&(this.suggestions=s,this.showSuggestions())}catch{}}async fetchSuggestions(e){if(!e||e.length<3)return null;let t=e.toLowerCase(),s=this.getCachedItem(t);if(s)return console.log(`Using cached results for: ${e}`),s.slice(0,5);if(this.lastQuery&&e.toLowerCase().startsWith(this.lastQuery.toLowerCase())&&this.suggestions.length===0)return console.log(`Skipping API call for: ${e} (extension of no-result query: ${this.lastQuery})`),[];let i=`https://us-autocomplete-pro.api.smartystreets.com/lookup?${new URLSearchParams({search:e,key:this.smartyKey,source:"all"})}`;this.apiCallCount++,console.log(`API Call #${this.apiCallCount} for: ${e}`),console.log(`Cache Stats - Hits: ${this.cacheHits}, Misses: ${this.cacheMisses}, Errors: ${this.cacheErrors}`),this.lastQuery=e;let n=await fetch(i);if(!n.ok)throw new Error("Failed to fetch suggestions");let a=((await n.json()).suggestions||[]).slice(0,5);return this.setCachedItem(t,a),a}showSuggestions(){if(!this.suggestions.length){this.hideSuggestions();return}if(!this.autocompleteContainer)return;let e=this.suggestions.map((t,s)=>`
        <div class="ffep-suggestion" data-index="${s}">
          ${t.street_line}, ${t.city}, ${t.state} ${t.zipcode}
        </div>
      `).join("");this.autocompleteContainer.innerHTML=e,this.autocompleteContainer.style.display="block",this.isAutocompleteVisible=!0,this.autocompleteContainer.querySelectorAll(".ffep-suggestion").forEach(t=>{t.addEventListener("click",()=>{let s=parseInt(t.dataset.index);this.selectSuggestion(s)})})}hideSuggestions(){this.autocompleteContainer.style.display="none",this.isAutocompleteVisible=!1,this.selectedIndex=-1}handleKeydown(e){if(!this.isAutocompleteVisible)return;let t=this.autocompleteContainer.querySelectorAll(".ffep-suggestion");if(t.length)switch(e.key){case"ArrowUp":e.preventDefault(),this.selectedIndex===-1?this.selectedIndex=t.length-1:this.navigateSuggestions(-1),this.handleArrowSelection();break;case"ArrowDown":e.preventDefault(),this.selectedIndex===-1?this.selectedIndex=0:this.navigateSuggestions(1),this.handleArrowSelection();break;case"Enter":if(this.selectedIndex!==-1){e.preventDefault();let s=t[this.selectedIndex];if(s){let i=parseInt(s.dataset.index);if(!isNaN(i)&&this.suggestions[i]){let n=this.suggestions[i];this.addressInput.value=`${n.street_line}, ${n.city}, ${n.state} ${n.zipcode}`,this.hideSuggestions(),this.form.dispatchEvent(new Event("submit"))}}}break;default:break}}navigateSuggestions(e){let t=this.autocompleteContainer.querySelectorAll(".ffep-suggestion");t.length&&(this.selectedIndex+=e,this.selectedIndex<0&&(this.selectedIndex=t.length-1),this.selectedIndex>=t.length&&(this.selectedIndex=0))}handleMouseOver(e){e.target.classList.contains("ffep-suggestion")&&(this.autocompleteContainer.querySelectorAll(".ffep-suggestion").forEach(s=>{s.classList.remove("hover")}),e.target.classList.add("hover"))}handleArrowSelection(){let e=this.autocompleteContainer.querySelectorAll(".ffep-suggestion");if(e.forEach(t=>{t.classList.remove("hover")}),this.selectedIndex!==-1){let t=e[this.selectedIndex];t&&t.classList.add("hover")}}selectSuggestion(e){let t=this.autocompleteContainer.querySelectorAll(".ffep-suggestion");if(e!==void 0&&t[e]){let s=t[e],i=parseInt(s.dataset.index);if(!isNaN(i)&&this.suggestions[i]){let n=this.suggestions[i];this.addressInput.value=`${n.street_line}, ${n.city}, ${n.state} ${n.zipcode}`,this.hideSuggestions(),this.form.dispatchEvent(new Event("submit"))}}}handleClickOutside(e){!this.autocompleteContainer.contains(e.target)&&e.target!==this.addressInput&&this.hideSuggestions()}};document.addEventListener("DOMContentLoaded",()=>{window.FFEP=r,new r().init()});})();
