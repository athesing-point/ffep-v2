"use strict";(()=>{var h={PDC:"17448046178191022",PDD:"17448045555816402"};function l(a,t){let e;return function(...i){return new Promise(n=>{let o=async()=>{clearTimeout(e),n(await a.apply(this,i))};clearTimeout(e);let r=typeof t=="function"?t(...i):t;e=setTimeout(o,r)})}}var c=class{constructor(){this.form=null,this.addressInput=null,this.autocompleteContainer=null,this.suggestions=[],this.selectedIndex=-1,this.isAutocompleteVisible=!1,this.apiCallCount=0,this.cacheHits=0,this.cacheMisses=0,this.cacheErrors=0,this.lastQuery="",this.errorElement=null,this.submitButton=null,this.CACHE_PREFIX="ffep_cache_",this.MAX_CACHE_ITEMS=50,this.cleanupCache(),console.log("FFEP Cache Initialized");let t=window.location.hostname;this.smartyKey=t.includes(".dev")?h.PDD:h.PDC,this.debouncedFetchSuggestions=l(this.fetchSuggestions.bind(this),e=>e.length<=4?50:200)}cleanupCache(){try{let t=this.getCacheKeys().length,e=this.getCacheKeys();if(e.length>this.MAX_CACHE_ITEMS){let s=e.slice(0,e.length-this.MAX_CACHE_ITEMS);s.forEach(i=>sessionStorage.removeItem(i)),console.log(`Cache Cleanup: Removed ${s.length} items. Before: ${t}, After: ${this.getCacheKeys().length}`)}}catch(t){console.warn("Cache cleanup failed:",t),this.cacheErrors++}}getCacheKeys(){return Object.keys(sessionStorage).filter(t=>t.startsWith(this.CACHE_PREFIX)).sort((t,e)=>{let s=JSON.parse(sessionStorage.getItem(t))?.timestamp||0,i=JSON.parse(sessionStorage.getItem(e))?.timestamp||0;return s-i})}getCachedItem(t){try{let e=sessionStorage.getItem(this.CACHE_PREFIX+t);if(!e)return console.log(`Cache Miss: ${t}`),this.cacheMisses++,null;let s=JSON.parse(e);return Date.now()-s.timestamp>30*60*1e3?(console.log(`Cache Expired: ${t}`),sessionStorage.removeItem(this.CACHE_PREFIX+t),this.cacheMisses++,null):(console.log(`Cache Hit: ${t}`),this.cacheHits++,s.data)}catch(e){return console.warn("Cache retrieval failed:",e),this.cacheErrors++,null}}setCachedItem(t,e){try{let s={timestamp:Date.now(),data:e};sessionStorage.setItem(this.CACHE_PREFIX+t,JSON.stringify(s)),console.log(`Cache Set: ${t}, Items in cache: ${this.getCacheKeys().length}`),this.cleanupCache()}catch(s){console.warn("Cache storage failed:",s),this.cacheErrors++;try{this.cleanupCache(),sessionStorage.setItem(this.CACHE_PREFIX+t,JSON.stringify(cacheItem)),console.log(`Cache Set Retry Successful: ${t}`)}catch(i){console.warn("Cache storage retry failed:",i),this.cacheErrors++}}}init(){if(this.addressInput=document.querySelector('[data-ffep="address"]'),!this.addressInput){console.error("Input with data-ffep='address' not found");return}this.submitButton=document.querySelector("#ffep-submit"),this.errorElement=document.querySelector(".ffep-error"),this.setupAutocomplete(),this.setupFormHandling()}setupAutocomplete(){this.autocompleteContainer=document.querySelector(".ffep-autocomplete"),this.autocompleteContainer&&(this.addressInput.addEventListener("input",this.handleInput.bind(this)),this.addressInput.addEventListener("keydown",this.handleKeydown.bind(this)),this.addressInput.addEventListener("focus",this.handleFocus.bind(this)),document.addEventListener("click",this.handleClickOutside.bind(this)),this.autocompleteContainer.addEventListener("mouseover",this.handleMouseOver.bind(this)))}setupFormHandling(){let t=async()=>{try{let e=this.addressInput.value,s=encodeURIComponent(e).replace(/%20/g,"+"),o=`https://home.point.${new URL(window.location.href).hostname.includes(".dev")?"dev":"com"}/?Enter+your+home+address=${s}&address=${s}`;window.location.replace(o)}catch(e){console.error("Error during redirect:",e),this.errorElement&&(this.errorElement.style.display="block")}};this.submitButton&&this.submitButton.addEventListener("click",e=>{e.preventDefault(),this.isAutocompleteVisible||t()}),this.addressInput.addEventListener("keydown",e=>{e.key==="Enter"&&!this.isAutocompleteVisible&&t()})}async handleInput(t){let e=t.target.value;if(e.length<3){this.hideSuggestions();return}try{let s=await this.debouncedFetchSuggestions(e);s&&(this.suggestions=s,this.showSuggestions())}catch{}}async fetchSuggestions(t){if(!t||t.length<3)return null;try{let e=t.toLowerCase(),s=this.getCachedItem(e);if(s)return console.log(`Using cached results for: ${t}`),s.slice(0,5);if(this.lastQuery&&t.toLowerCase().startsWith(this.lastQuery.toLowerCase())&&this.suggestions.length===0)return console.log(`Skipping API call for: ${t} (extension of no-result query: ${this.lastQuery})`),[];let i=`https://us-autocomplete-pro.api.smartystreets.com/lookup?${new URLSearchParams({search:t,key:this.smartyKey,source:"all"})}`;this.apiCallCount++,console.log(`API Call #${this.apiCallCount} for: ${t}`),console.log(`Cache Stats - Hits: ${this.cacheHits}, Misses: ${this.cacheMisses}, Errors: ${this.cacheErrors}`),this.lastQuery=t;let n=await fetch(i);if(!n.ok)throw new Error("Failed to fetch suggestions");let r=((await n.json()).suggestions||[]).slice(0,5);return this.setCachedItem(e,r),this.errorElement&&(this.errorElement.style.display="none"),r}catch(e){return console.error("Error fetching suggestions:",e),this.errorElement&&(this.errorElement.style.display="block"),[]}}showSuggestions(){if(!this.suggestions.length){this.hideSuggestions();return}if(!this.autocompleteContainer)return;let t=this.suggestions.map((e,s)=>`
        <div class="ffep-suggestion" data-index="${s}" role="option" aria-selected="false">
          ${e.street_line}, ${e.city}, ${e.state} ${e.zipcode}
        </div>
      `).join("");this.autocompleteContainer.innerHTML=t,this.autocompleteContainer.style.display="block",this.isAutocompleteVisible=!0,this.autocompleteContainer.querySelectorAll(".ffep-suggestion").forEach(e=>{e.addEventListener("click",()=>{let s=parseInt(e.dataset.index);this.selectSuggestion(s)})})}hideSuggestions(){this.autocompleteContainer.style.display="none",this.isAutocompleteVisible=!1,this.selectedIndex=-1}handleKeydown(t){if(!this.isAutocompleteVisible)return;let e=this.autocompleteContainer.querySelectorAll(".ffep-suggestion");if(e.length)switch(t.key){case"ArrowUp":t.preventDefault(),this.selectedIndex===-1?this.selectedIndex=e.length-1:this.navigateSuggestions(-1),this.handleArrowSelection();break;case"ArrowDown":t.preventDefault(),this.selectedIndex===-1?this.selectedIndex=0:this.navigateSuggestions(1),this.handleArrowSelection();break;case"Enter":if(this.selectedIndex!==-1){t.preventDefault();let s=e[this.selectedIndex];if(s){let i=parseInt(s.dataset.index);if(!isNaN(i)&&this.suggestions[i]){let n=this.suggestions[i];this.addressInput.value=`${n.street_line}, ${n.city}, ${n.state} ${n.zipcode}`,this.hideSuggestions(),this.form.dispatchEvent(new Event("submit"))}}}break;default:break}}navigateSuggestions(t){let e=this.autocompleteContainer.querySelectorAll(".ffep-suggestion");e.length&&(this.selectedIndex+=t,this.selectedIndex<0&&(this.selectedIndex=e.length-1),this.selectedIndex>=e.length&&(this.selectedIndex=0))}handleMouseOver(t){t.target.classList.contains("ffep-suggestion")&&(this.autocompleteContainer.querySelectorAll(".ffep-suggestion").forEach(s=>{s.classList.remove("hover")}),t.target.classList.add("hover"))}handleArrowSelection(){this.autocompleteContainer.querySelectorAll(".ffep-suggestion").forEach((e,s)=>{e.classList.remove("hover"),e.setAttribute("aria-selected","false"),s===this.selectedIndex&&(e.classList.add("hover"),e.setAttribute("aria-selected","true"))})}selectSuggestion(t){let e=this.autocompleteContainer.querySelectorAll(".ffep-suggestion");if(t!==void 0&&e[t]){let s=e[t],i=parseInt(s.dataset.index);if(!isNaN(i)&&this.suggestions[i]){let n=this.suggestions[i];this.addressInput.value=`${n.street_line}, ${n.city}, ${n.state} ${n.zipcode}`,this.hideSuggestions(),this.form.dispatchEvent(new Event("submit"))}}}handleClickOutside(t){!this.autocompleteContainer.contains(t.target)&&t.target!==this.addressInput&&this.hideSuggestions()}async handleFocus(t){let e=t.target.value;if(!(e.length<3)&&!this.isAutocompleteVisible)try{let s=e.toLowerCase(),i=this.getCachedItem(s);i&&i.length>0&&(console.log(`Reshowing cached results for: ${e} on focus`),this.suggestions=i,this.showSuggestions())}catch(s){console.error("Error fetching cached suggestions on focus:",s)}}};document.addEventListener("DOMContentLoaded",()=>{window.FFEP=c,new c().init()});})();
