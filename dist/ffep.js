(()=>{var z={PDC:"17448046178191022",PDD:"17448045555816402"};function C(G,j){let H;return function J(...L){return new Promise((N)=>{let Q=async()=>{clearTimeout(H),N(await G.apply(this,L))};clearTimeout(H);let X=typeof j==="function"?j(...L):j;H=setTimeout(Q,X)})}}class ${constructor(){this.form=null,this.addressInput=null,this.autocompleteContainer=null,this.suggestions=[],this.selectedIndex=-1,this.isAutocompleteVisible=!1,this.apiCallCount=0,this.cacheHits=0,this.cacheMisses=0,this.cacheErrors=0,this.lastQuery="",this.errorElement=null,this.submitButton=null,this.CACHE_PREFIX="ffep_cache_",this.MAX_CACHE_ITEMS=50,this.cleanupCache(),console.log("FFEP Cache Initialized");let G=window.location.hostname;this.smartyKey=G.includes(".dev")?z.PDD:z.PDC,this.debouncedFetchSuggestions=C(this.fetchSuggestions.bind(this),(j)=>j.length<=4?50:200)}cleanupCache(){try{let G=this.getCacheKeys().length,j=this.getCacheKeys();if(j.length>this.MAX_CACHE_ITEMS){let H=j.slice(0,j.length-this.MAX_CACHE_ITEMS);H.forEach((J)=>sessionStorage.removeItem(J)),console.log(`Cache Cleanup: Removed ${H.length} items. Before: ${G}, After: ${this.getCacheKeys().length}`)}}catch(G){console.warn("Cache cleanup failed:",G),this.cacheErrors++}}getCacheKeys(){return Object.keys(sessionStorage).filter((G)=>G.startsWith(this.CACHE_PREFIX)).sort((G,j)=>{let H=JSON.parse(sessionStorage.getItem(G))?.timestamp||0,J=JSON.parse(sessionStorage.getItem(j))?.timestamp||0;return H-J})}getCachedItem(G){try{let j=sessionStorage.getItem(this.CACHE_PREFIX+G);if(!j)return console.log(`Cache Miss: ${G}`),this.cacheMisses++,null;let H=JSON.parse(j);if(Date.now()-H.timestamp>1800000)return console.log(`Cache Expired: ${G}`),sessionStorage.removeItem(this.CACHE_PREFIX+G),this.cacheMisses++,null;return console.log(`Cache Hit: ${G}`),this.cacheHits++,H.data}catch(j){return console.warn("Cache retrieval failed:",j),this.cacheErrors++,null}}setCachedItem(G,j){try{let H={timestamp:Date.now(),data:j};sessionStorage.setItem(this.CACHE_PREFIX+G,JSON.stringify(H)),console.log(`Cache Set: ${G}, Items in cache: ${this.getCacheKeys().length}`),this.cleanupCache()}catch(H){console.warn("Cache storage failed:",H),this.cacheErrors++;try{this.cleanupCache(),sessionStorage.setItem(this.CACHE_PREFIX+G,JSON.stringify(cacheItem)),console.log(`Cache Set Retry Successful: ${G}`)}catch(J){console.warn("Cache storage retry failed:",J),this.cacheErrors++}}}init(){if(this.addressInput=document.querySelector('[data-ffep="address"]'),!this.addressInput){console.error("Input with data-ffep='address' not found");return}this.submitButton=document.querySelector("#ffep-submit"),this.errorElement=document.querySelector(".ffep-error"),this.setupAutocomplete(),this.setupFormHandling()}setupAutocomplete(){if(this.autocompleteContainer=document.querySelector(".ffep-autocomplete"),!this.autocompleteContainer)return;this.addressInput.addEventListener("input",this.handleInput.bind(this)),this.addressInput.addEventListener("keydown",this.handleKeydown.bind(this)),this.addressInput.addEventListener("focus",this.handleFocus.bind(this)),document.addEventListener("click",this.handleClickOutside.bind(this)),this.autocompleteContainer.addEventListener("mouseover",this.handleMouseOver.bind(this))}setupFormHandling(){let G=async()=>{try{let j=this.addressInput.value,H=encodeURIComponent(j).replace(/%20/g,"+"),N=`https://home.point.${new URL(window.location.href).hostname.includes(".dev")?"dev":"com"}/?Enter+your+home+address=${H}&address=${H}`;window.location.replace(N)}catch(j){if(console.error("Error during redirect:",j),this.errorElement)this.errorElement.style.display="block"}};if(this.submitButton)this.submitButton.addEventListener("click",(j)=>{if(j.preventDefault(),!this.isAutocompleteVisible)G()});this.addressInput.addEventListener("keydown",(j)=>{if(j.key==="Enter"&&!this.isAutocompleteVisible)G()})}async handleInput(G){let j=G.target.value;if(j.length<3){this.hideSuggestions();return}try{let H=await this.debouncedFetchSuggestions(j);if(H)this.suggestions=H,this.showSuggestions()}catch(H){}}async fetchSuggestions(G){if(!G||G.length<3)return null;try{let j=G.toLowerCase(),H=this.getCachedItem(j);if(H)return console.log(`Using cached results for: ${G}`),H.slice(0,5);if(this.lastQuery&&G.toLowerCase().startsWith(this.lastQuery.toLowerCase())&&this.suggestions.length===0)return console.log(`Skipping API call for: ${G} (extension of no-result query: ${this.lastQuery})`),[];let J=`https://us-autocomplete-pro.api.smartystreets.com/lookup?${new URLSearchParams({search:G,key:this.smartyKey,source:"all"})}`;this.apiCallCount++,console.log(`API Call #${this.apiCallCount} for: ${G}`),console.log(`Cache Stats - Hits: ${this.cacheHits}, Misses: ${this.cacheMisses}, Errors: ${this.cacheErrors}`),this.lastQuery=G;let L=await fetch(J);if(!L.ok)throw new Error("Failed to fetch suggestions");let Q=((await L.json()).suggestions||[]).slice(0,5);if(this.setCachedItem(j,Q),this.errorElement)this.errorElement.style.display="none";return Q}catch(j){if(console.error("Error fetching suggestions:",j),this.errorElement)this.errorElement.style.display="block";return[]}}showSuggestions(){if(!this.suggestions.length){this.hideSuggestions();return}if(!this.autocompleteContainer)return;let G=this.suggestions.map((j,H)=>`
        <div class="ffep-suggestion" data-index="${H}" role="option" aria-selected="false">
          ${j.street_line}, ${j.city}, ${j.state} ${j.zipcode}
        </div>
      `).join("");this.autocompleteContainer.innerHTML=G,this.autocompleteContainer.style.display="block",this.isAutocompleteVisible=!0,this.autocompleteContainer.querySelectorAll(".ffep-suggestion").forEach((j)=>{j.addEventListener("click",()=>{let H=parseInt(j.dataset.index);this.selectSuggestion(H)})})}hideSuggestions(){this.autocompleteContainer.style.display="none",this.isAutocompleteVisible=!1,this.selectedIndex=-1}handleKeydown(G){if(!this.isAutocompleteVisible)return;let j=this.autocompleteContainer.querySelectorAll(".ffep-suggestion");if(!j.length)return;switch(G.key){case"ArrowUp":if(G.preventDefault(),this.selectedIndex===-1)this.selectedIndex=j.length-1;else this.navigateSuggestions(-1);this.handleArrowSelection();break;case"ArrowDown":if(G.preventDefault(),this.selectedIndex===-1)this.selectedIndex=0;else this.navigateSuggestions(1);this.handleArrowSelection();break;case"Enter":if(this.selectedIndex!==-1){G.preventDefault();let H=j[this.selectedIndex];if(H){let J=parseInt(H.dataset.index);if(!isNaN(J)&&this.suggestions[J]){let L=this.suggestions[J],N=`${L.street_line}, ${L.city}, ${L.state} ${L.zipcode}`;this.addressInput.value=N,this.hideSuggestions();let Q=encodeURIComponent(N).replace(/%20/g,"+"),Z=`https://home.point.${window.location.hostname.includes(".dev")?"dev":"com"}/?Enter+your+home+address=${Q}&address=${Q}`;window.location.replace(Z)}}}break;default:break}}navigateSuggestions(G){let j=this.autocompleteContainer.querySelectorAll(".ffep-suggestion");if(!j.length)return;if(this.selectedIndex+=G,this.selectedIndex<0)this.selectedIndex=j.length-1;if(this.selectedIndex>=j.length)this.selectedIndex=0}handleMouseOver(G){if(G.target.classList.contains("ffep-suggestion"))this.autocompleteContainer.querySelectorAll(".ffep-suggestion").forEach((H)=>{H.classList.remove("hover")}),G.target.classList.add("hover")}handleArrowSelection(){this.autocompleteContainer.querySelectorAll(".ffep-suggestion").forEach((j,H)=>{if(j.classList.remove("hover"),j.setAttribute("aria-selected","false"),H===this.selectedIndex)j.classList.add("hover"),j.setAttribute("aria-selected","true")})}selectSuggestion(G){let j=this.autocompleteContainer.querySelectorAll(".ffep-suggestion");if(G!==void 0&&j[G]){let H=j[G],J=parseInt(H.dataset.index);if(!isNaN(J)&&this.suggestions[J]){let L=this.suggestions[J],N=`${L.street_line}, ${L.city}, ${L.state} ${L.zipcode}`;this.addressInput.value=N,this.hideSuggestions();let Q=encodeURIComponent(N).replace(/%20/g,"+"),Z=`https://home.point.${window.location.hostname.includes(".dev")?"dev":"com"}/?Enter+your+home+address=${Q}&address=${Q}`;window.location.replace(Z)}}}handleClickOutside(G){if(!this.autocompleteContainer.contains(G.target)&&G.target!==this.addressInput)this.hideSuggestions()}async handleFocus(G){let j=G.target.value;if(j.length<3)return;if(this.isAutocompleteVisible)return;try{let H=j.toLowerCase(),J=this.getCachedItem(H);if(J&&J.length>0)console.log(`Reshowing cached results for: ${j} on focus`),this.suggestions=J,this.showSuggestions()}catch(H){console.error("Error fetching cached suggestions on focus:",H)}}}document.addEventListener("DOMContentLoaded",()=>{window.FFEP=$,new $().init()});})();
