(()=>{var Z={PDC:"17448046178191022",PDD:"17448045555816402"};function z(j,G){let H;return function J(...L){return new Promise((Q)=>{let N=async()=>{clearTimeout(H),Q(await j.apply(this,L))};clearTimeout(H);let $=typeof G==="function"?G(...L):G;H=setTimeout(N,$)})}}class X{constructor(){this.form=null,this.addressInput=null,this.autocompleteContainer=null,this.suggestions=[],this.selectedIndex=-1,this.isAutocompleteVisible=!1,this.apiCallCount=0,this.cacheHits=0,this.cacheMisses=0,this.cacheErrors=0,this.lastQuery="",this.CACHE_PREFIX="ffep_cache_",this.MAX_CACHE_ITEMS=50,this.cleanupCache(),console.log("FFEP Cache Initialized");let j=window.location.hostname;this.smartyKey=j.includes(".dev")?Z.PDD:Z.PDC,this.debouncedFetchSuggestions=z(this.fetchSuggestions.bind(this),(G)=>G.length<=4?50:200)}cleanupCache(){try{let j=this.getCacheKeys().length,G=this.getCacheKeys();if(G.length>this.MAX_CACHE_ITEMS){let H=G.slice(0,G.length-this.MAX_CACHE_ITEMS);H.forEach((J)=>sessionStorage.removeItem(J)),console.log(`Cache Cleanup: Removed ${H.length} items. Before: ${j}, After: ${this.getCacheKeys().length}`)}}catch(j){console.warn("Cache cleanup failed:",j),this.cacheErrors++}}getCacheKeys(){return Object.keys(sessionStorage).filter((j)=>j.startsWith(this.CACHE_PREFIX)).sort((j,G)=>{let H=JSON.parse(sessionStorage.getItem(j))?.timestamp||0,J=JSON.parse(sessionStorage.getItem(G))?.timestamp||0;return H-J})}getCachedItem(j){try{let G=sessionStorage.getItem(this.CACHE_PREFIX+j);if(!G)return console.log(`Cache Miss: ${j}`),this.cacheMisses++,null;let H=JSON.parse(G);if(Date.now()-H.timestamp>1800000)return console.log(`Cache Expired: ${j}`),sessionStorage.removeItem(this.CACHE_PREFIX+j),this.cacheMisses++,null;return console.log(`Cache Hit: ${j}`),this.cacheHits++,H.data}catch(G){return console.warn("Cache retrieval failed:",G),this.cacheErrors++,null}}setCachedItem(j,G){try{let H={timestamp:Date.now(),data:G};sessionStorage.setItem(this.CACHE_PREFIX+j,JSON.stringify(H)),console.log(`Cache Set: ${j}, Items in cache: ${this.getCacheKeys().length}`),this.cleanupCache()}catch(H){console.warn("Cache storage failed:",H),this.cacheErrors++;try{this.cleanupCache(),sessionStorage.setItem(this.CACHE_PREFIX+j,JSON.stringify(cacheItem)),console.log(`Cache Set Retry Successful: ${j}`)}catch(J){console.warn("Cache storage retry failed:",J),this.cacheErrors++}}}init(){if(this.form=document.querySelector('form[data-ffep="form"]'),!this.form){console.error("data-ffep='form' element not found");return}if(this.addressInput=this.form.querySelector('[data-ffep="address"]'),!this.addressInput)return;this.setupAutocomplete(),this.setupFormHandling()}setupAutocomplete(){if(this.autocompleteContainer=document.querySelector(".ffep-autocomplete"),!this.autocompleteContainer)return;this.addressInput.addEventListener("input",this.handleInput.bind(this)),this.addressInput.addEventListener("keydown",this.handleKeydown.bind(this)),document.addEventListener("click",this.handleClickOutside.bind(this))}setupFormHandling(){this.form.addEventListener("submit",async(j)=>{j.preventDefault();let G=this.addressInput.value,H=encodeURIComponent(G).replace(/%20/g,"+"),Q=`https://home.point.${new URL(window.location.href).hostname.includes(".dev")?"dev":"com"}/?Enter+your+home+address=${H}&address=${H}`;window.location.replace(Q)})}async handleInput(j){let G=j.target.value;if(G.length<3){this.hideSuggestions();return}try{let H=await this.debouncedFetchSuggestions(G);if(H)this.suggestions=H,this.showSuggestions()}catch(H){}}async fetchSuggestions(j){if(!j||j.length<3)return null;let G=j.toLowerCase(),H=this.getCachedItem(G);if(H)return console.log(`Using cached results for: ${j}`),H;if(this.lastQuery&&j.toLowerCase().startsWith(this.lastQuery.toLowerCase())&&this.suggestions.length===0)return console.log(`Skipping API call for: ${j} (extension of no-result query: ${this.lastQuery})`),[];let J=`https://us-autocomplete-pro.api.smartystreets.com/lookup?${new URLSearchParams({search:j,key:this.smartyKey,source:"all"})}`;this.apiCallCount++,console.log(`API Call #${this.apiCallCount} for: ${j}`),console.log(`Cache Stats - Hits: ${this.cacheHits}, Misses: ${this.cacheMisses}, Errors: ${this.cacheErrors}`),this.lastQuery=j;let L=await fetch(J);if(!L.ok)throw new Error("Failed to fetch suggestions");let N=(await L.json()).suggestions||[];return this.setCachedItem(G,N),N}showSuggestions(){if(!this.suggestions.length){this.hideSuggestions();return}if(!this.autocompleteContainer)return;let j=this.suggestions.map((G,H)=>`
        <div class="ffep-suggestion ${H===this.selectedIndex?"selected":""}"
             data-index="${H}">
          ${G.street_line}, ${G.city}, ${G.state} ${G.zipcode}
        </div>
      `).join("");this.autocompleteContainer.innerHTML=j,this.autocompleteContainer.style.display="block",this.isAutocompleteVisible=!0,this.autocompleteContainer.querySelectorAll(".ffep-suggestion").forEach((G)=>{G.addEventListener("click",()=>{let H=parseInt(G.dataset.index);this.selectSuggestion(H)}),G.addEventListener("mouseover",()=>{this.selectedIndex=parseInt(G.dataset.index),this.highlightSuggestion()})})}hideSuggestions(){this.autocompleteContainer.style.display="none",this.isAutocompleteVisible=!1,this.selectedIndex=-1}handleKeydown(j){if(!this.isAutocompleteVisible)return;switch(j.key){case"ArrowDown":j.preventDefault(),this.selectedIndex=Math.min(this.selectedIndex+1,this.suggestions.length-1),this.highlightSuggestion();break;case"ArrowUp":j.preventDefault(),this.selectedIndex=Math.max(this.selectedIndex-1,0),this.highlightSuggestion();break;case"Enter":if(this.selectedIndex>=0)j.preventDefault(),this.selectSuggestion(this.selectedIndex);break;case"Escape":this.hideSuggestions();break}}highlightSuggestion(){this.autocompleteContainer.querySelectorAll(".ffep-suggestion").forEach((G,H)=>{if(H===this.selectedIndex)G.scrollIntoView({block:"nearest",behavior:"smooth"})})}selectSuggestion(j){let G=this.suggestions[j];this.addressInput.value=`${G.street_line}, ${G.city}, ${G.state} ${G.zipcode}`,this.hideSuggestions();let H=this.addressInput.value,J=encodeURIComponent(H).replace(/%20/g,"+"),N=`https://home.point.${new URL(window.location.href).hostname.includes(".dev")?"dev":"com"}/?Enter+your+home+address=${J}&address=${J}`;window.location.replace(N)}handleClickOutside(j){if(!this.autocompleteContainer.contains(j.target)&&j.target!==this.addressInput)this.hideSuggestions()}}document.addEventListener("DOMContentLoaded",()=>{window.FFEP=X,new X().init()});})();
